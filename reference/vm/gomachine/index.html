<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.58.3"><meta name=description content="This page describes the plumbing inside the Go Machine"><meta name=author content="The Gorgonia Authors"><link rel="shortcut icon" href=/images/favicon.png type=image/png><title>Go Machine :: Gorgonia</title><link href=/css/nucleus.css?1636396250 rel=stylesheet><link href=/css/fontawesome-all.min.css?1636396250 rel=stylesheet><link href=/css/hybrid.css?1636396250 rel=stylesheet><link href=/css/featherlight.min.css?1636396250 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1636396250 rel=stylesheet><link href=/css/auto-complete.css?1636396250 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1636396250 rel=stylesheet><link href=/css/theme.css?1636396250 rel=stylesheet><link href=/css/hugo-theme.css?1636396250 rel=stylesheet><link href=/css/theme-gorgonia.css?1636396250 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1636396250></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script type=text/x-mathjax-config>
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script><meta property=og:title content="Go Machine"><meta property=og:description content="This page describes the plumbing inside the Go Machine"><meta property=og:type content=article><meta property=og:url content=https://gorgonia.org/reference/vm/gomachine/><meta property=og:image content=https://gorgonia.org/images/opengraph.png><meta property=article:published_time content=2019-10-29T19:50:15+01:00><meta property=article:modified_time content=2019-10-29T19:50:15+01:00><meta property=og:site_name content=Gorgonia><meta name=twitter:card content=summary_large_image><meta name=twitter:image content=https://gorgonia.org/images/opengraph.png><meta name=twitter:title content="Go Machine"><meta name=twitter:description content="This page describes the plumbing inside the Go Machine"></head><body data-url=/reference/vm/gomachine/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=https://gorgonia.org/><img src=https://gorgonia.org/images/logo/gorgonia.svg></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1636396250></script><script type=text/javascript src=/js/auto-complete.js?1636396250></script><script type=text/javascript>var baseurl="https:\/\/gorgonia.org\/";</script><script type=text/javascript src=/js/search.js?1636396250></script><ul><li><a class=padding><em class="fas fa-language fa-fw"></em><div class=select-style><select id=select-language onchange="location=this.value;">
<option id=en value=https://gorgonia.org/reference/vm/gomachine/ selected>English</option>
<option id=fr value=https://gorgonia.org/fr/reference/vm/gomachine/>Fran√ßais</option></select><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="255" height="255" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255"><g><g id="arrow-drop-down"><path d="M0 63.75l127.5 127.5L255 63.75z" /></g></g></svg></div></a></li></ul></div><div class=highlightable><ul class=topics><li data-nav-id=/getting-started/ title="Getting Started" class=dd-item><a href=/getting-started/>Getting Started
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/getting-started/ubiquitous-language/ title="Ubiquitous Language and glossary" class=dd-item><a href=/getting-started/ubiquitous-language/>Ubiquitous Language and glossary
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/getting-started/contributing-doc/ title="Start contributing to the doc" class=dd-item><a href=/getting-started/contributing-doc/>Start contributing to the doc
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/about/ title="How Gorgonia works" class=dd-item><a href=/about/>How Gorgonia works
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/about/computation-graph/ title="Computation Graph" class=dd-item><a href=/about/computation-graph/>Computation Graph
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/about/differentiation/ title=Differentiation class=dd-item><a href=/about/differentiation/>Differentiation
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/about/differentiation/autodiff/ title="Automatic Differentiation" class=dd-item><a href=/about/differentiation/autodiff/>Automatic Differentiation
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/about/differentiation/symbolicdiff/ title="Symbolic Differentiation" class=dd-item><a href=/about/differentiation/symbolicdiff/>Symbolic Differentiation
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul></li><li data-nav-id=/tutorials/ title=Tutorials class=dd-item><a href=/tutorials/>Tutorials
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/tutorials/hello-world/ title="Hello World" class=dd-item><a href=/tutorials/hello-world/>Hello World
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/tutorials/mnist/ title="Simple Convolution Neural Net (MNIST)" class=dd-item><a href=/tutorials/mnist/>Simple Convolution Neural Net (MNIST)
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/tutorials/mnist-cuda/ title="Convnet with CUDA" class=dd-item><a href=/tutorials/mnist-cuda/>Convnet with CUDA
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/tutorials/iris/ title="Multivariate linear regression on Iris Dataset" class=dd-item><a href=/tutorials/iris/>Multivariate linear regression on Iris Dataset
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/how-to/ title="How To" class=dd-item><a href=/how-to/>How To
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/how-to/troubleshoot-gpu-issues/ title="Troubleshoot GPU Issues" class=dd-item><a href=/how-to/troubleshoot-gpu-issues/>Troubleshoot GPU Issues
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/how-to/dot/ title="Drawing the ExprGraph with Graphviz (dot)" class=dd-item><a href=/how-to/dot/>Drawing the ExprGraph with Graphviz (dot)
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/how-to/dataframe/ title="Create a tensor from a Dataframe (gota)" class=dd-item><a href=/how-to/dataframe/>Create a tensor from a Dataframe (gota)
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/how-to/save-weights/ title="Save Weights" class=dd-item><a href=/how-to/save-weights/>Save Weights
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/how-to/autodiff/ title="How to compute gradient (differentiation)" class=dd-item><a href=/how-to/autodiff/>How to compute gradient (differentiation)
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/reference/ title="Reference guide" class="dd-item
        parent"><a href=/reference/>Reference guide
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/reference/exprgraph/ title="Graph / Exprgraph" class=dd-item><a href=/reference/exprgraph/>Graph / Exprgraph
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/present/ title=Present class=dd-item><a href=/reference/present/>Present
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/cuda/ title="CUDA support" class=dd-item><a href=/reference/cuda/>CUDA support
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/tensor/ title=Tensor class=dd-item><a href=/reference/tensor/>Tensor
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/solver/ title=Solvers class=dd-item><a href=/reference/solver/>Solvers
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/vm/ title=VM class="dd-item
        parent"><a href=/reference/vm/>VM
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/reference/vm/gomachine/ title="Go Machine" class="dd-item active"><a href=/reference/vm/gomachine/>Go Machine
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/vm/lispmachine/ title=LispMachine class=dd-item><a href=/reference/vm/lispmachine/>LispMachine
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/vm/tapemachine/ title=Tapemachine class=dd-item><a href=/reference/vm/tapemachine/>Tapemachine
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul></li><li data-nav-id=/misc/ title=Miscellaneous class=dd-item><a href=/misc/>Miscellaneous
<i class="fas fa-check read-icon"></i></a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/gorgonia/gorgonia><i class="fab fa-fw fa-github"></i>GitHub repo</a></li><li><a class=padding href="https://pkg.go.dev/gorgonia.org/gorgonia?tab=doc"><i class="fas fa-fw fa-bookmark"></i>API Doc</a></li><li><a class=padding href=http://gophers.slack.com/messages/gorgonia><i class="fab fa-fw fa-slack"></i>Contact us</a></li></ul></section><section id=prefooter><hr><ul><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i>Clear History</a></li></ul></section><section id=footer><center><a class=github-button href=https://github.com/gorgonia/gorgonia data-icon=octicon-star data-show-count=true aria-label="Star gorgonia/gorgonia on GitHub">Star</a><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a>from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></center><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/gorgonia/gorgonia.github.io/edit/develop/content/reference/vm/gomachine.md target=blank><i class="fas fa-code-branch"></i><span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://schema.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/>main</a> > <a href=/reference/>Reference guide</a> > <a href=/reference/vm/>VM</a> > Go Machine</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#the-states-of-the-nodes>The states of the nodes</a><ul><li><a href=#implementation>Implementation</a></li><li><a href=#running-the-state-machine>Running the state machine</a></li><li><a href=#state-modification-on-event>State modification on event</a></li></ul></li><li><a href=#communication-hub>Communication HUB</a><ul><li><a href=#publish-subscribe>Publish / subscribe</a><ul><li><a href=#merge-and-broadcast>Merge and broadcast</a></li></ul></li><li><a href=#pubsub>pubsub</a><ul><li><a href=#about-iovalue>about <code>ioValue</code></a></li></ul></li></ul></li><li><a href=#the-machine>The machine</a><ul><li><a href=#creating-a-machine>Creating a machine</a></li><li><a href=#running-the-machine>Running the machine</a></li><li><a href=#closing-the-machine>Closing the machine</a></li></ul></li><li><a href=#misc>Misc</a></li><li><a href=#example>Example</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Go Machine</h1><p>This page explains the plumbing inside the GoMachine.</p><p>GoMachine is an experimental feature hold in the <a href=https://github.com/gorgonia/gorgonia/tree/master/x/vm><code>xvm</code> package</a>.
The API of the package and its name may change.</p><p>This document is based on <a href=https://github.com/gorgonia/gorgonia/tree/7538ab3b58ceae68f162c17d19052324bf1dc587>commit 7538ab3</a></p><h2 id=the-states-of-the-nodes>The states of the nodes</h2><p>The principle relies on the state of the nodes.</p><p>As explained in <a href="https://www.youtube.com/watch?v=HxaD_trXwRE"><em>Lexical Scanning in Go</em></a>:</p><ul><li>a state represents where we are</li><li>an action represents what we do</li><li>actions result in a new state</li></ul><p>As of today, the GoMachine expects a node to be in those possible states:</p><ul><li><em>waiting for input</em></li><li><em>emitting output</em></li></ul><p>If a node is carrying an operator may have an extra state:</p><ul><li><em>computing</em></li></ul><div class="notices info"><p>Later, a new state will eventually be added when implementing automatic differentiation: <em>computing gradient</em></p></div><p>This leads to this state graph of the possible states of a node:</p><div class=mermaid align=left>graph TB;
A(Initial Stage) --> BB{input is an op}
BB -->|no| D[Emit output]
BB -->|yes| B[Waiting for input]
B --> C{inputs == arity}
C -->|no| B
C -->|yes| Computing
Computing --> E{Has error}
E -->|no| D
E -->|yes| F
D --> F(end)</div><h3 id=implementation>Implementation</h3><p>The <code>node</code> is a private structure:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>node</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span></code></pre></div><p>We define a type <code>stateFn</code> that represents an action to perform on a <code>*node</code> in a specific <code>context</code>, and returns a new state. This type is a <code>func</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>stateFn</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>stateFn</span></code></pre></div><p><em>Note</em>: It is the responsibility of every state function to handle context cancelation mechanism. This means that if a cancelation signal is received, the node should return the end state. For simplicity:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>mystate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>stateFn</span> <span style=color:#000;font-weight:700>{</span> 
    <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>():</span>
            <span style=color:#000>n</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>()</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>We define four functions of type <code>stateFn</code> to implement the actions required by the node:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>defaultState</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>stateFn</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>receiveInput</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>stateFn</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>computeFwd</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>stateFn</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>emitOutput</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>stateFn</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p><em>Note</em>: the <code>end</code> state is <code>nil</code> (the zero value of the <code>stateFn</code>)</p><h3 id=running-the-state-machine>Running the state machine</h3><p>Each node is a state machine.
To run it, we set a method <code>run</code> that takes a context as an argument.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Compute</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>defaultState</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>state</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>state</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>n</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>err</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p><em>Note</em>: the <code>*node</code> stores an error that should be set by a stateFn that indicates the reason why it broke the state machine (for example, if an error occurs during the computation, this error contains the reason)</p><p>Then every <code>*node</code> is triggered in its own goroutine by the machine.</p><h3 id=state-modification-on-event>State modification on event</h3><p>We use the paradigm of reactive programming to switch from a state to another.</p><p>A change in the <code>*node</code> structure triggers an action that induces the change of state.</p><p>For example, let&rsquo;s take a simple calculator that computes <code>a+b</code>.</p><ul><li>$+$ is waiting for two inputs values to do the sum $a$ and $b$</li><li>$a$ is waiting for a value</li><li>$b$ is waiting for a value</li></ul><p>When we <em>send</em> a value to $a$</p><p>$+$ is notified of this event ($a$ owns a value); it receives and stores the value internally.</p><p>Then we <em>send</em> a value to $b$, $+$ is notified, and <em>receives</em> the value. Then its state changes to <code>compute</code>.</p><p>Once computed, the $+$ <em>sends</em> the result to whoever is interested in using it.</p><p>In Go sending and receiving values, and events programming are implemented with channels.</p><p>The node structure owns two channels, one to receive the input (<code>inputC</code>), and one to emit the output (<code>outputC</code>):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>node</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>outputC</span>        <span style=color:#204a87;font-weight:700>chan</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Value</span>
	<span style=color:#000>inputC</span>         <span style=color:#204a87;font-weight:700>chan</span> <span style=color:#000>ioValue</span>
    <span style=color:#000>err</span>            <span style=color:#204a87;font-weight:700>error</span>
    <span style=color:#8f5902;font-style:italic>// ...
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span></code></pre></div><p><em>Note</em>: the <code>ioValue</code> structure is explained later in this doc; for now, consider <code>ioValue</code> = <code>gorgonia.Value</code></p><h2 id=communication-hub>Communication HUB</h2><p>Now we have all nodes running in goroutines; we need to wire them together actually to compute formulae.</p><p>For example, in: $ a\times x+b$, we need to send the result of $a\times x$ into the node carrying the <em>addition</em> operator.</p><p>which is roughly:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>aTimesX</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>op</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>mul</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>aTimesXPlusB</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>op</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>sum</span><span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>a</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>c</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Value</span>

<span style=color:#000>aTimesX</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inputC</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>a</span>
<span style=color:#000>aTimesX</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inputC</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>x</span>
<span style=color:#000>aTimesXPlusB</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inputC</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>aTimesX</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>outputC</span> 
<span style=color:#000>aTimesXPlusB</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inputC</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>b</span></code></pre></div><p>The problem is that a channel is not a &ldquo;topic&rdquo; and it does not handle subscriptions natively. The first consumer takes a value, and drain the channel.</p><p>Therefore if we take this equation $(a + b) \times c + (a + b) \times d$, the implementation would not work:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style=display:block;width:100%;background-color:#dfdfdf><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style=display:block;width:100%;background-color:#dfdfdf><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>aPlusB</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>op</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>add</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>aPlusBTimesC</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>op</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>mul</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>aPlusBTimesCPlusAPlusB</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>op</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>add</span><span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>a</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>c</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Value</span>

<span style=color:#000>aPlusB</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inputC</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>a</span>
<span style=color:#000>aPlusB</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inputC</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>b</span>
<span style=display:block;width:100%;background-color:#dfdfdf><span style=color:#000>aPlusBTimesC</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inputC</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>aPlusB</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>outputC</span>
</span><span style=color:#000>aPlusBTimesC</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inputC</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>c</span>
<span style=color:#000>aPlusBTimesCPlusAPlusB</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>aPlusBTimesC</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>outputC</span>
<span style=display:block;width:100%;background-color:#dfdfdf><span style=color:#000>aPlusBTimesCPlusAPlusB</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>aPlusB</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>outputC</span> <span style=color:#ce5c00;font-weight:700>//</span> <span style=color:#000>Deadlock</span></span></code></pre></td></tr></table></div></div><p>This will provide a deadlock because <code>aPlusB.outputC</code> is emptied at line 9 and therefore line 12 will never receive value anymore.</p><p>The solution is to use temporary channels and a broadcast mechanism as described in the article <a href=https://blog.golang.org/pipelines#TOC_4.>Go Concurrency Patterns: Pipelines and cancellation</a>.</p><h3 id=publish-subscribe>Publish / subscribe</h3><p>A node is publishing some content to some subscribers.
A node is also subscribing to content sent by publishers.</p><p>We setup two structures:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>publisher</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>id</span>          <span style=color:#204a87;font-weight:700>int64</span>
	<span style=color:#000>publisher</span>   <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Value</span>
	<span style=color:#000>subscribers</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>chan</span><span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Value</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>subscriber</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>id</span>         <span style=color:#204a87;font-weight:700>int64</span>
	<span style=color:#000>publishers</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Value</span>
	<span style=color:#000>subscriber</span> <span style=color:#204a87;font-weight:700>chan</span><span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>ioValue</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>Each node providing output via the <code>outputC</code> is a publisher, and all the nodes in the graph reaching this node are its subscriber<strong>s</strong>. This defines a <code>publisher</code> object. The ID of the object is the ID of the node providing its output.</p><p>Each node expecting inputs via its <code>inputC</code> is a subscriber. The publisher<strong>s</strong> are the node reached by this node in the <code>*ExprGraph</code></p><h4 id=merge-and-broadcast>Merge and broadcast</h4><p>publishers are broadcasting their data to the subscriber by calling</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>broadcast</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>globalWG</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WaitGroup</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ch</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Value</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cs</span> <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#204a87;font-weight:700>chan</span><span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span> </code></pre></div><p>subscribers are merging the results from the publishers by calling:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>merge</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>globalWG</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WaitGroup</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>out</span> <span style=color:#204a87;font-weight:700>chan</span><span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>ioValue</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cs</span> <span style=color:#ce5c00;font-weight:700>...&lt;-</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p><em>Note</em>: both functions are handling context cancelation</p><h3 id=pubsub>pubsub</h3><p>To wire all the publishers and subscribers, we use a top-level structure: <code>pubsub</code></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>pubsub</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>publishers</span>  <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>publisher</span>
	<span style=color:#000>subscribers</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>subscriber</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p><code>pubsub</code> is in charge of setting up the network of channels.</p><p>Then a <code>run(context.Context)</code> method is triggering the <code>broadcast</code> and <code>merge</code> for all elements:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>pubsub</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>run</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CancelFunc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WaitGroup</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>This method returns a <code>context.CancelFunc</code> and a <code>sync.WaitGroup</code> that will be down to zero when all pubsubs are settled after a cancelation.</p><h4 id=about-iovalue>about <code>ioValue</code></h4><p>The subscriber has a single input channel; the input values can be sent in any order.
The subscriber&rsquo;s merge function tracks the order of the subscribers, wraps the value into the ioValue structure, and adds the position of the operator emitting the value:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ioValue</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>pos</span> <span style=color:#204a87;font-weight:700>int</span>
	<span style=color:#000>v</span>   <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Value</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><h2 id=the-machine>The machine</h2><p>The <code>Machine</code> is the only exported structure of the package.</p><p>It is a support for nodes and pubsub.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Machine</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>nodes</span>  <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>node</span>
	<span style=color:#000>pubsub</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>pubsub</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><h3 id=creating-a-machine>Creating a machine</h3><p>A machine is created from an <code>*ExprGraph</code> by calling</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>NewMachine</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>g</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ExprGraph</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Machine</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>Under the hood, it parses the graph and generates a <code>*node</code> for each <code>*gorgonia.Node</code>.
If a node carries an Op (= an object that implements a <code>Do(... Value) Value</code> method), a pointer to the Op is added to the structure.</p><div class="notices info"><p>For transitioning, the package declares a <code>Doer</code> interface.
This interface is fulfilled by the <code>*gorgonia.Node</code> structure.</p></div><p>Two individual cases are handled:</p><ul><li>the top-level node of the <code>*ExprGraph</code> have <code>outputC = nil</code></li><li>the bottom nodes of the <code>*ExprGraph</code> have <code>inputC = nil</code></li></ul><p>Then the <code>NewMachine</code> calls the <code>createNetwork</code> methods to create the <code>*pubsub</code> elements.</p><h3 id=running-the-machine>Running the machine</h3><p>A call to the <code>Run</code> method of the Machine triggers the computation.
The call to this function is blocking.
It returns an error and stops the process if:
- all the nodes have reached their final states
- one node&rsquo;s execution state returns an error</p><p>In case of error, a cancel signal is automatically sent to the <code>*pubsub</code> infrastructure to avoid leakage.</p><h3 id=closing-the-machine>Closing the machine</h3><p>After the computation, it is safe to call <code>Close</code> to avoid a memory leak.
<code>Close()</code> closes all the channels hold by the <code>*node</code> and the <code>*pubsub</code></p><h2 id=misc>Misc</h2><p>It is important to notice that the machine is independent of the <code>*ExprGraph</code>. Therefore the values held by the <code>*gorgonia.Node</code> are not updated.</p><p>To access the data, you must call the <code>GetResult</code> method of the machine. This method takes a node ID as input (<code>*node</code> and <code>*gorgonia.Node</code> have the same IDs)</p><p>Ex:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>add</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>b</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Println</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>machine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GetResult</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>add</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ID</span><span style=color:#000;font-weight:700>()))</span></code></pre></div><h2 id=example>Example</h2><p>This is a trivial example that computes two float 32</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(){</span>
    <span style=color:#000>g</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewGraph</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>forty</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>F32</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>40.0</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>two</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>F32</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2.0</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>n1</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewScalar</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>g</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Float32</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithValue</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>forty</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithName</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;n1&#34;</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#000>n2</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewScalar</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>g</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Float32</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithValue</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>two</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithName</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;n2&#34;</span><span style=color:#000;font-weight:700>))</span>

    <span style=color:#000>added</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>gorgonia</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>n1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>n2</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Fatal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000>machine</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>NewMachine</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>g</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cancel</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithTimeout</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Background</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#0000cf;font-weight:700>1000</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Millisecond</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>cancel</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>machine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Close</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>machine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Run</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Fatal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Println</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>machine</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GetResult</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>added</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ID</span><span style=color:#000;font-weight:700>()))</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>prints</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#0000cf;font-weight:700>42</span></code></pre></div><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/reference/vm/ title=VM><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=/reference/vm/lispmachine/ title=LispMachine style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1636396250></script><script src=/js/perfect-scrollbar.min.js?1636396250></script><script src=/js/perfect-scrollbar.jquery.min.js?1636396250></script><script src=/js/jquery.sticky.js?1636396250></script><script src=/js/featherlight.min.js?1636396250></script><script src=/js/modernizr.custom-3.6.0.js?1636396250></script><script src=/js/learn.js?1636396250></script><script src=/js/hugo-learn.js?1636396250></script><link href=/mermaid/mermaid.css?1636396250 rel=stylesheet><script src=/mermaid/mermaid.js?1636396250></script><script>mermaid.initialize({startOnLoad:true});</script></body></html>