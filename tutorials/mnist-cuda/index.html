<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.58.3"><meta name=description content="Gorgonia: Deep learning for Go - Write and evaluate mathematical equations involving multidimensional arrays (tensors) easily - this is the reference website with tutorials and howtos"><meta name=author content="The Gorgonia Authors"><link rel="shortcut icon" href=/images/favicon.png type=image/png><title>Convnet with CUDA :: Gorgonia</title><link href=/css/nucleus.css?1677767295 rel=stylesheet><link href=/css/fontawesome-all.min.css?1677767295 rel=stylesheet><link href=/css/hybrid.css?1677767295 rel=stylesheet><link href=/css/featherlight.min.css?1677767295 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1677767295 rel=stylesheet><link href=/css/auto-complete.css?1677767295 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1677767295 rel=stylesheet><link href=/css/theme.css?1677767295 rel=stylesheet><link href=/css/hugo-theme.css?1677767295 rel=stylesheet><link href=/css/theme-gorgonia.css?1677767295 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1677767295></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><script type=text/x-mathjax-config>
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script><meta property=og:title content="Convnet with CUDA"><meta property=og:description content="This tutorial describes how to run the simple convolutional neural network on a GPU.
The example used in this tutorial is based on MNIST. Your development environment should be ready as described in the tutorial &ldquo;Simple convolution neural net (mnist)&rdquo;
Preparing the CUDA binding The CUDA binding relies on CGO and the official CUDA toolkit. You can install it manually or, if you use AWS, you can rely on an AMI with all the pre-requisites."><meta property=og:type content=article><meta property=og:url content=https://gorgonia.org/tutorials/mnist-cuda/><meta property=og:image content=https://gorgonia.org/images/opengraph.png><meta property=article:published_time content=2020-02-16T22:08:40+01:00><meta property=article:modified_time content=2020-02-16T22:08:40+01:00><meta property=og:site_name content=Gorgonia><meta name=twitter:card content=summary_large_image><meta name=twitter:image content=https://gorgonia.org/images/opengraph.png><meta name=twitter:title content="Convnet with CUDA"><meta name=twitter:description content="This tutorial describes how to run the simple convolutional neural network on a GPU.
The example used in this tutorial is based on MNIST. Your development environment should be ready as described in the tutorial &ldquo;Simple convolution neural net (mnist)&rdquo;
Preparing the CUDA binding The CUDA binding relies on CGO and the official CUDA toolkit. You can install it manually or, if you use AWS, you can rely on an AMI with all the pre-requisites."></head><body data-url=/tutorials/mnist-cuda/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=https://gorgonia.org/><img src=https://gorgonia.org/images/logo/gorgonia.svg></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1677767295></script><script type=text/javascript src=/js/auto-complete.js?1677767295></script><script type=text/javascript>var baseurl="https:\/\/gorgonia.org\/";</script><script type=text/javascript src=/js/search.js?1677767295></script><ul><li><a class=padding><em class="fas fa-language fa-fw"></em><div class=select-style><select id=select-language onchange="location=this.value;">
<option id=en value=https://gorgonia.org/tutorials/mnist-cuda/ selected>English</option></select><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="255" height="255" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255"><g><g id="arrow-drop-down"><path d="M0 63.75l127.5 127.5L255 63.75z" /></g></g></svg></div></a></li></ul></div><div class=highlightable><ul class=topics><li data-nav-id=/getting-started/ title="Getting Started" class=dd-item><a href=/getting-started/>Getting Started
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/getting-started/ubiquitous-language/ title="Ubiquitous Language and glossary" class=dd-item><a href=/getting-started/ubiquitous-language/>Ubiquitous Language and glossary
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/getting-started/contributing-doc/ title="Start contributing to the doc" class=dd-item><a href=/getting-started/contributing-doc/>Start contributing to the doc
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/about/ title="How Gorgonia works" class=dd-item><a href=/about/>How Gorgonia works
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/about/computation-graph/ title="Computation Graph" class=dd-item><a href=/about/computation-graph/>Computation Graph
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/about/differentiation/ title=Differentiation class=dd-item><a href=/about/differentiation/>Differentiation
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/about/differentiation/autodiff/ title="Automatic Differentiation" class=dd-item><a href=/about/differentiation/autodiff/>Automatic Differentiation
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/about/differentiation/symbolicdiff/ title="Symbolic Differentiation" class=dd-item><a href=/about/differentiation/symbolicdiff/>Symbolic Differentiation
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul></li><li data-nav-id=/tutorials/ title=Tutorials class="dd-item
        parent"><a href=/tutorials/>Tutorials
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/tutorials/hello-world/ title="Hello World" class=dd-item><a href=/tutorials/hello-world/>Hello World
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/tutorials/mnist/ title="Simple Convolution Neural Net (MNIST)" class=dd-item><a href=/tutorials/mnist/>Simple Convolution Neural Net (MNIST)
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/tutorials/mnist-cuda/ title="Convnet with CUDA" class="dd-item active"><a href=/tutorials/mnist-cuda/>Convnet with CUDA
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/tutorials/iris/ title="Multivariate linear regression on Iris Dataset" class=dd-item><a href=/tutorials/iris/>Multivariate linear regression on Iris Dataset
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/how-to/ title="How To" class=dd-item><a href=/how-to/>How To
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/how-to/troubleshoot-gpu-issues/ title="Troubleshoot GPU Issues" class=dd-item><a href=/how-to/troubleshoot-gpu-issues/>Troubleshoot GPU Issues
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/how-to/dot/ title="Drawing the ExprGraph with Graphviz (dot)" class=dd-item><a href=/how-to/dot/>Drawing the ExprGraph with Graphviz (dot)
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/how-to/dataframe/ title="Create a tensor from a Dataframe (gota)" class=dd-item><a href=/how-to/dataframe/>Create a tensor from a Dataframe (gota)
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/how-to/save-weights/ title="Save Weights" class=dd-item><a href=/how-to/save-weights/>Save Weights
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/how-to/autodiff/ title="How to compute gradient (differentiation)" class=dd-item><a href=/how-to/autodiff/>How to compute gradient (differentiation)
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/reference/ title="Reference guide" class=dd-item><a href=/reference/>Reference guide
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/reference/exprgraph/ title="Graph / Exprgraph" class=dd-item><a href=/reference/exprgraph/>Graph / Exprgraph
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/present/ title=Present class=dd-item><a href=/reference/present/>Present
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/cuda/ title="CUDA support" class=dd-item><a href=/reference/cuda/>CUDA support
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/tensor/ title=Tensor class=dd-item><a href=/reference/tensor/>Tensor
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/solver/ title=Solvers class=dd-item><a href=/reference/solver/>Solvers
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/vm/ title=VM class=dd-item><a href=/reference/vm/>VM
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/reference/vm/gomachine/ title="Go Machine" class=dd-item><a href=/reference/vm/gomachine/>Go Machine
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/vm/lispmachine/ title=LispMachine class=dd-item><a href=/reference/vm/lispmachine/>LispMachine
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/reference/vm/tapemachine/ title=Tapemachine class=dd-item><a href=/reference/vm/tapemachine/>Tapemachine
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul></li><li data-nav-id=/misc/ title=Miscellaneous class=dd-item><a href=/misc/>Miscellaneous
<i class="fas fa-check read-icon"></i></a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/gorgonia/gorgonia><i class="fab fa-fw fa-github"></i>GitHub repo</a></li><li><a class=padding href="https://pkg.go.dev/gorgonia.org/gorgonia?tab=doc"><i class="fas fa-fw fa-bookmark"></i>API Doc</a></li><li><a class=padding href=http://gophers.slack.com/messages/gorgonia><i class="fab fa-fw fa-slack"></i>Contact us</a></li></ul></section><section id=prefooter><hr><ul><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i>Clear History</a></li></ul></section><section id=footer><center><a class=github-button href=https://github.com/gorgonia/gorgonia data-icon=octicon-star data-show-count=true aria-label="Star gorgonia/gorgonia on GitHub">Star</a><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a>from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></center><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/gorgonia/gorgonia.github.io/edit/develop/content/tutorials/mnist-cuda.md target=blank><i class="fas fa-code-branch"></i><span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://schema.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/>main</a> > <a href=/tutorials/>Tutorials</a> > Convnet with CUDA</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#preparing-the-cuda-binding>Preparing the CUDA binding</a><ul><li><a href=#installing-the-cuda-toolkit-manually>Installing the CUDA toolkit manually</a></li><li><a href=#using-aws-ec2>Using AWS EC2</a></li></ul></li><li><a href=#preparing-the-code>Preparing the code</a></li><li><a href=#running-the-example>Running the example</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Convnet with CUDA</h1><p>This tutorial describes how to run the simple convolutional neural network on a GPU.</p><p>The example used in this tutorial is based on MNIST. Your development environment should be ready as described in the tutorial <a href=/tutorials/mnist/>&ldquo;Simple convolution neural net (mnist)&rdquo;</a></p><h2 id=preparing-the-cuda-binding>Preparing the CUDA binding</h2><p>The CUDA binding relies on CGO and the official CUDA toolkit. You can install it manually or, if you use AWS, you can rely on an AMI with all the pre-requisites.</p><h3 id=installing-the-cuda-toolkit-manually>Installing the CUDA toolkit manually</h3><p>The installation of the CUDA toolkit is out-of-scope of this tutorial. But you must ensure that:</p><ol><li><a href=https://developer.nvidia.com/CUDA-toolkit>CUDA toolkit</a> is installed (version 10 has been tested successfully). Installing this installs the <code>nvcc</code> compiler, which is required to run your code with CUDA.</li><li>you run the <a href=http://docs.nvidia.com/CUDA/CUDA-installation-guide-linux/index.html#post-installation-actions>post-installation steps</a></li></ol><h3 id=using-aws-ec2>Using AWS EC2</h3><p>AWS provides AMI with the CUDA toolkit pre-installed.
You can have a list of those AMI thanks to this command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>~ aws ec2 describe-images --owners amazon --filters <span style=color:#4e9a06>&#39;Name=state,Values=available&#39;</span> <span style=color:#4e9a06>&#39;Name=name,Values=Deep Learning AMI (Ubuntu)*&#39;</span> --query <span style=color:#4e9a06>&#39;sort_by(Images, &amp;CreationDate)[].Name&#39;</span></code></pre></div><p>Those AMI have been tested successfully on <code>g3s.xlarge</code> against version 0.9.8 of Gorgonia.</p><div class="notices info"><p>For convenience, you can find a <a href=terraform.io>terraform</a> file to help you kickstarting a VM on AWS EC2 <a href=https://github.com/gorgonia/dev/tree/master/infrastructure/aws/gpu>here</a></p></div><h2 id=preparing-the-code>Preparing the code</h2><p>There is many different hardware. To address the specificities, Gorgonia provides a command that generates binding specifically for your hardware. This function is carried by a specific tool call <code>CUDAgen</code></p><div class="notices warning"><p><code>CUDAgen</code> does not play well with go modules, and you need to turn them off.</p></div><p>Those commands install the <code>cudagen</code> tool and generate the CUDA binding.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>~ <span style=color:#204a87>export</span> <span style=color:#000>GO111MODULE</span><span style=color:#ce5c00;font-weight:700>=</span>off
~ go get gorgonia.org/gorgonia
~ <span style=color:#204a87>export</span> <span style=color:#000>CGO_CFLAGS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;-I/usr/local/cuda-10.0/include/&#34;</span>
~ <span style=color:#204a87>export</span> <span style=color:#000>PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$PATH</span>:/usr/local/cuda/bin/
~ go get gorgonia.org/cu
~ go install gorgonia.org/gorgonia/cmd/cudagen
~ <span style=color:#000>$GOPATH</span>/bin/cudagen</code></pre></div><h2 id=running-the-example>Running the example</h2><p>Gorgonia&rsquo;s example directory contains a <a href=https://github.com/gorgonia/gorgonia/tree/master/examples/convnet_cuda><code>convenet_CUDA</code></a> example.
This example runs a convolution neural network against the MNIST database.</p><div class="notices info"><p>The code is similar to the <code>convnet</code> example; the only difference is in the operators import;
This version uses the operators&rsquo; from the <a href=https://github.com/gorgonia/gorgonia/tree/master/ops/nn><code>nnops</code></a>. This package holds a couple of operator definitions mostly used in neural networks (<code>Conv2D</code>, <code>Maxpool</code>, &hellip;); the definitions have a signature that makes them compatible with their counterpart in CUDA. Package <code>nnops</code> ensure the compatibility with the CPU version of the operator if CUDA is not used.</p></div><p>Assuming that the tests file are in place in <code>../testdata</code> (cf the tutorial <a href=/tutorials/mnist/>&ldquo;Simple convolution neural net (mnist)&rdquo;</a> if it&rsquo;s not), you can launch the training phase with a CUDA support by simply running:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>time go run -tags=&#39;CUDA&#39;  main.go -epochs 1 2&gt; /dev/null
Epoch 0 599 / 600 [====================================================]  99.83%</code></pre></div><p>It is also possible to &ldquo;monitor&rdquo; the CUDA usage by running the <code>nvidia-smi</code> command in a separate window.
This should display something like this:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>~  nvidia-smi
Sun Feb 16 22:05:15 2020
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 418.87.00    Driver Version: 418.87.00    CUDA Version: 10.1     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|===============================+======================+======================|
|   0  Tesla M60           On   | 00000000:00:1E.0 Off |                    0 |
| N/A   54C    P0    73W / 150W |    841MiB /  7618MiB |     76%      Default |
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
| Processes:                                                       GPU Memory |
|  GPU       PID   Type   Process name                             Usage      |
|=============================================================================|
|    0     18614      C   /tmp/go-build629284435/b001/exe/main         372MiB |
+-----------------------------------------------------------------------------+</code></pre></div><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/tutorials/mnist/ title="Simple Convolution Neural Net (MNIST)"><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=/tutorials/iris/ title="Multivariate linear regression on Iris Dataset" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1677767295></script><script src=/js/perfect-scrollbar.min.js?1677767295></script><script src=/js/perfect-scrollbar.jquery.min.js?1677767295></script><script src=/js/jquery.sticky.js?1677767295></script><script src=/js/featherlight.min.js?1677767295></script><script src=/js/modernizr.custom-3.6.0.js?1677767295></script><script src=/js/learn.js?1677767295></script><script src=/js/hugo-learn.js?1677767295></script><link href=/mermaid/mermaid.css?1677767295 rel=stylesheet><script src=/mermaid/mermaid.js?1677767295></script><script>mermaid.initialize({startOnLoad:true});</script></body></html>